import React from "react";
import { withNamespaces } from "react-i18next";
import { Section } from "@datawheel/canon-core";
import FeaturedDatum from "components/FeaturedDatum";

import { numeral } from "helpers/formatters";

import Axios from "axios";
import VulnerabilityTooltip from "../../../../components/VulnerabilityTooltip";

class VulnerabilitySlide extends Section {
  constructor(props) {
    super(props);
    this.state = {
      total: undefined,
      first: undefined,
      second: undefined,
      third: undefined
    };
  }
  componentDidMount() {
    const { geo } = this.context.data;
    const geoType =
      geo.type.substring(0, 1).toUpperCase() + geo.type.substring(1);

    let path = `/api/data?measures=Count&drilldowns=Priority,Year`;
    if (geo.depth > 0) path += `&${geoType}=${geo.key}`;

    Axios.get(path).then(resp => {
      const data = resp.data.data.filter(d => d["ID Year"] === 2018);
      const first = data.find(d => d["ID Priority"] === 1) || {};
      const second = data.find(d => d["ID Priority"] === 2) || {};
      const third = data.find(d => d["ID Priority"] === 3) || {};
      const total = data.reduce((all, d) => {
        if ([1, 2, 3].includes(d["ID Priority"])) return all + d["Count"];
        return all;
      }, 0);
      this.setState({
        total,
        first: first["Count"],
        second: second["Count"],
        third: third["Count"]
      });
    });
  }

  render() {
    const { children, t, i18n } = this.props;
    let { geo } = this.context.data;

    const locale = i18n.language;

    const { first, second, third, total } = this.state;

    return (
      <div className="topic-slide-block">
        <div className="topic-slide-intro">
          <h3 className="topic-slide-title u-visually-hidden">
            {t("Performance Evaluation")}
          </h3>
          <div className="topic-slide-text">
            <p>
              {t("junaeb_vulnerability", {
                total,
                rate: numeral(first / total, locale).format("0.0%"),
                first: numeral(first, locale).format("0,0"),
                name: geo.caption
              })}
            </p>
          </div>
          <div className="topic-slide-data">
            {first && (
              <FeaturedDatum
                className="l-1-3"
                icon="estudiantes-cantidad"
                datum={numeral(first, locale).format("0,0")}
                title={t("First Priority")}
                subtitle={t("Students")}
              />
            )}
            {second && (
              <FeaturedDatum
                className="l-1-3"
                icon="estudiantes-cantidad"
                datum={numeral(second, locale).format("0,0")}
                title={t("Second Priority")}
                subtitle={t("Students")}
              />
            )}
            {third && (
              <FeaturedDatum
                className="l-1-3"
                icon="estudiantes-cantidad"
                datum={numeral(third, locale).format("0,0")}
                title={t("Third Priority")}
                subtitle={t("Students")}
              />
            )}
          </div>
          <div className="topic-slide-text">
            <h4 className="topic-slide-context-subhead">
              {t("About the School Vulnerability Index")}
              <VulnerabilityTooltip />
            </h4>

            <p className="font-xxs">{t("junaeb_about")}</p>
          </div>
        </div>
        <div className="topic-slide-charts">{children}</div>
      </div>
    );
  }
}

export default withNamespaces()(VulnerabilitySlide);
